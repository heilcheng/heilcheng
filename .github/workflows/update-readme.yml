name: Update README

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:  # Manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update README
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set +e  # Don't exit on error
          USERNAME="heilcheng"
          
          # ============================================
          # 1. GitHub Stats (stars, PRs, contributions)
          # ============================================
          
          # Get total stars across all repos
          REPOS_RESPONSE=$(curl -s "https://api.github.com/users/${USERNAME}/repos?per_page=100")
          if echo "$REPOS_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
            STARS=$(echo "$REPOS_RESPONSE" | jq '[.[].stargazers_count] | add // 0')
          else
            STARS="0"
          fi
          
          # Get total PRs (using search API)
          PRS_RESPONSE=$(curl -s "https://api.github.com/search/issues?q=author:${USERNAME}+type:pr")
          if echo "$PRS_RESPONSE" | jq -e '.total_count' > /dev/null 2>&1; then
            PRS=$(echo "$PRS_RESPONSE" | jq '.total_count // 0')
          else
            PRS="0"
          fi
          
          # Get contributions from committers.top
          RANKING_PAGE=$(curl -s "https://committers.top/hong_kong.html" || echo "")
          CONTRIBS=$(echo "$RANKING_PAGE" | grep -A2 "heilcheng" | grep -oE '[0-9]+' | tail -1 || echo "")
          if [ -z "$CONTRIBS" ]; then
            CONTRIBS="800+"
          fi
          
          # ============================================
          # 2. GitHub HK Ranking (scrape from page)
          # ============================================
          
          # Find rank from the committers.top page - look for the row number
          RANK=$(echo "$RANKING_PAGE" | grep -B2 "heilcheng" | grep -oE '[0-9]+\.' | head -1 | tr -d '.' || echo "")
          if [ -z "$RANK" ]; then
            # Fallback: try the badge SVG
            BADGE_SVG=$(curl -s "https://user-badge.committers.top/hong_kong/${USERNAME}.svg" || echo "")
            RANK=$(echo "$BADGE_SVG" | grep -oE '#[0-9]+' | head -1 | tr -d '#' || echo "")
          fi
          if [ -z "$RANK" ]; then
            RANK="36"  # Known rank as fallback
          fi
          
          # ============================================
          # 3. Random Dog Fact
          # ============================================
          
          # Use a simpler dog fact API
          DOG_RESPONSE=$(curl -s "https://dog-api.kinduff.com/api/facts" || echo "")
          if echo "$DOG_RESPONSE" | jq -e '.facts[0]' > /dev/null 2>&1; then
            DOG_FACT=$(echo "$DOG_RESPONSE" | jq -r '.facts[0]' | head -c 120)
          else
            # Fallback facts array
            FACTS=(
              "Dogs have three eyelids"
              "A dog's nose print is unique, like a fingerprint"
              "Dogs can smell your feelings"
              "Puppies are born deaf"
              "Dogs dream just like humans"
              "A dog's sense of smell is 10,000 times stronger than humans"
              "Dogs can learn more than 1000 words"
              "Greyhounds can run up to 45 mph"
            )
            DOG_FACT="${FACTS[$((RANDOM % ${#FACTS[@]}))]}"
          fi
          
          # ============================================
          # 4. Detailed Hong Kong Weather
          # ============================================
          
          WEATHER_DATA=$(curl -s "https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=en" || echo "{}")
          
          # Check if we got valid JSON
          if ! echo "$WEATHER_DATA" | jq -e '.temperature' > /dev/null 2>&1; then
            TEMP="--"
            HUMIDITY="--"
            WEATHER_EMOJI="ğŸŒ¡ï¸"
          else
            # Temperature - try HK Observatory first, then fallback to first station
            TEMP=$(echo "$WEATHER_DATA" | jq -r '.temperature.data[] | select(.place == "Hong Kong Observatory") | .value' 2>/dev/null | head -1)
            if [ -z "$TEMP" ] || [ "$TEMP" = "null" ]; then
              TEMP=$(echo "$WEATHER_DATA" | jq -r '.temperature.data[0].value // "--"' 2>/dev/null)
            fi
            
            # Humidity
            HUMIDITY=$(echo "$WEATHER_DATA" | jq -r '.humidity.data[0].value // "--"' 2>/dev/null)
            
            # Weather icon/description
            ICON_CODE=$(echo "$WEATHER_DATA" | jq -r '.icon[0] // 50' 2>/dev/null)
            
            # Map icon codes to emojis
            case "$ICON_CODE" in
              50) WEATHER_EMOJI="â˜€ï¸" ;; # Sunny
              51) WEATHER_EMOJI="ğŸŒ¤ï¸" ;; # Sunny Periods
              52) WEATHER_EMOJI="ğŸŒ¥ï¸" ;; # Sunny Intervals
              53) WEATHER_EMOJI="ğŸŒ¦ï¸" ;; # Sunny Periods with Showers
              54) WEATHER_EMOJI="ğŸŒ¦ï¸" ;; # Sunny Intervals with Showers
              60) WEATHER_EMOJI="â˜ï¸" ;; # Cloudy
              61) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Overcast
              62) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Light Rain
              63) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Rain
              64) WEATHER_EMOJI="â›ˆï¸" ;; # Heavy Rain
              65) WEATHER_EMOJI="â›ˆï¸" ;; # Thunderstorms
              70) WEATHER_EMOJI="ğŸŒ™" ;; # Fine Night
              71) WEATHER_EMOJI="ğŸŒ™" ;; # Fine Night
              72) WEATHER_EMOJI="â˜ï¸" ;; # Cloudy Night
              73) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Rainy Night
              74) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Rainy Night
              75) WEATHER_EMOJI="ğŸŒ§ï¸" ;; # Rainy Night
              76) WEATHER_EMOJI="â›ˆï¸" ;; # Thundery Night
              77) WEATHER_EMOJI="ğŸŒ™" ;; # Mainly Cloudy
              80) WEATHER_EMOJI="ğŸŒªï¸" ;; # Windy
              81) WEATHER_EMOJI="â„ï¸" ;; # Dry/Cold
              82) WEATHER_EMOJI="ğŸŒ«ï¸" ;; # Mist
              83) WEATHER_EMOJI="ğŸŒ«ï¸" ;; # Fog
              84) WEATHER_EMOJI="ğŸŒ«ï¸" ;; # Haze
              85) WEATHER_EMOJI="ğŸŒ«ï¸" ;; # Mist
              90) WEATHER_EMOJI="ğŸ¥µ" ;; # Hot
              91) WEATHER_EMOJI="ğŸ˜°" ;; # Warm & Humid
              92) WEATHER_EMOJI="ğŸ¥¶" ;; # Cool
              93) WEATHER_EMOJI="â„ï¸" ;; # Cold
              *) WEATHER_EMOJI="ğŸŒ¡ï¸" ;;
            esac
          fi
          
          # Rainfall warning if any
          RAINFALL=$(echo "$WEATHER_DATA" | jq -r '.rainfall.data[0].max // 0' 2>/dev/null || echo "0")
          if [ "$RAINFALL" != "0" ] && [ "$RAINFALL" != "null" ] && [ -n "$RAINFALL" ]; then
            RAIN_INFO=" Â· ğŸŒ§ï¸ ${RAINFALL}mm"
          else
            RAIN_INFO=""
          fi
          
          # ============================================
          # Update README
          # ============================================
          
          # Escape special characters for sed
          DOG_FACT_ESCAPED=$(echo "$DOG_FACT" | sed 's/[&/\]/\\&/g' | tr -d '\n' | head -c 120)
          
          # Debug output
          echo "Stats: â­ ${STARS} stars Â· ğŸ”€ ${PRS} PRs Â· ğŸ’» ${CONTRIBS} contributions"
          echo "Rank: #${RANK}"
          echo "Weather: ${WEATHER_EMOJI} ${TEMP}Â°C Â· ğŸ’§ ${HUMIDITY}%${RAIN_INFO}"
          echo "Dog fact: ${DOG_FACT_ESCAPED}"
          
          sed -i "s/<!-- STATS -->.*<!-- \/STATS -->/<!-- STATS -->â­ ${STARS} stars Â· ğŸ”€ ${PRS} PRs Â· ğŸ’» ${CONTRIBS} contributions<!-- \/STATS -->/" README.md
          sed -i "s/<!-- RANK -->.*<!-- \/RANK -->/<!-- RANK -->ğŸ† #${RANK} <a href=\"https:\/\/committers.top\/hong_kong.html\">most active GitHub user in Hong Kong<\/a><!-- \/RANK -->/" README.md
          sed -i "s/<!-- DOG -->.*<!-- \/DOG -->/<!-- DOG -->ğŸ• ${DOG_FACT_ESCAPED}<!-- \/DOG -->/" README.md
          sed -i "s/<!-- WEATHER -->.*<!-- \/WEATHER -->/<!-- WEATHER -->${WEATHER_EMOJI} ${TEMP}Â°C Â· ğŸ’§ ${HUMIDITY}% in Hong Kong<!-- \/WEATHER -->/" README.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š Update stats, ranking, weather & dog fact"
          git push
